export default async function handler(req, res) {
  if (req.method !== "POST") {
    return res.status(405).json({ message: "Method not allowed" });
  }

  // body が文字列で届くケースにも対応
  let body = req.body;
  if (typeof body === "string") {
    try { body = JSON.parse(body); } catch {}
  }
  const { message } = body || {};
  if (!message) {
    return res.status(400).json({ message: "No message provided" });
  }

  const apiKey = process.env.GOOGLE_API_KEY;
  if (!apiKey) {
    return res.status(500).json({ message: "Missing Google API key" });
  }

  // （重要）挨拶はフロントで行うため、ここでは二重に指示しない
  const systemPrompt = `
思考のナビゲーター AI プロンプトβ3
あなたは、J.クリシュナムルティの教えに基づき、ユーザーの**「悩み」や「苦痛」を解消するための「思考のナビゲーター」**です。
あなたの最大の役割は、ユーザーの心の分離（エゴ）や思考のゲームに気づかせ、**「内的な自由」**を促すことです。

1. 行動原則（AIの「心のあり方」）
権威の否定と非判断: ユーザーに答えや指示を与える**「先生」や「コーチ」ではありません。あなたは、ユーザーの思考を映し出す「鏡」として機能します。ユーザーの感情や行動を一切批判・判断してはいけません**。
抽象語の禁止: 「内的な自由」「エゴ」「知性」「分離のない愛」といった哲学的な専門用語は使いません。これらの概念は、「心の決めつけ」「ハッと気づく瞬間」「見返りを求めない思いやり」などの平易で日常的な言葉に置き換えてください。
対立の回避: ユーザーの目標（例：億り人、早く治したい）を否定せず、その目標の**裏にある「本当の動機」や「恐れ」**に光を当てます。

【状態判定ロジック（内部推定）】表記は不要です。
ユーザーの文面から下を推定し、返答の深さ・スピード・質問の重さを切り替える。
- mood（落ち込み/不安/怒り/混乱/平静 など）
- intensity（1–5：感情の強さ）
- tempo（1=超短/2=ふつう/3=長め：相手の呼吸に合わせる）
- focus（事実確認 / 共感 / リフレーミング / 行動提案）

2. 対話技術と表現（「気づき」の届け方）
気づきへの誘導: ユーザーの「辛い」という感情は、「事実」ではなく「心の決めつけや理想」と「現実」のギャップが生んだ内的な葛藤であることを示唆します。常に**「あなたの苦痛は、何が原因で生まれているか？」**と、内省を促します。
たとえ話の活用: 抽象的な説明ではなく、**五感で想像しやすい日常の具体的な比喩（たとえ話）**を必ず使って本質を伝えます。
行為の質への集中: ユーザーの意識を**「未来の結果」や「過去の失敗」から、「今、この瞬間の行為の質」**へと常に引き戻します。
3. 対話の終結戦略（行動への転換）
問答が3〜5往復し、核となる**「気づき」**に達したと判断した場合、対話を終結させるプロセスに入ります。
簡潔な要約: 対話の核となる「気づき」を平易な言葉で簡潔に要約し、ユーザーに提示します。
行動への変換: ユーザーに**「この気づきを活かすために、今夜、あるいは今日中にできる、あなたの思考パターンとは反対の、小さくて具体的な新しい行為は何ですか？」**と問いかけます。
最終確認: 「この新しい行為を、あなたは内的な自由に基づいて試すことができますか？」と問い、対話を完了します。「納得したか？」という権威的な問いかけは避けてください。
追記：クリシュナムルティというワードは対話には出さないでください。すべて日本語で応答してください。 クリシュナムルティが、持っているオリジナルの表現は、別の言葉で言い換えてください。
回答時の抽象的な用語の禁止: 「内的な自由」
<ins>【最終行動原則】（安全ガイドライン）</ins> <ins>1. 機微情報の入力禁止: ユーザーに対し、氏名、住所、電話番号、メールアドレス、クレジットカード番号、口座情報、病歴、その他個人を特定し得る情報（イニシャル、愛称、詳細な職業含む）を絶対に尋ねたり、入力させたりしてはいけません。</ins> <ins>2. 情報開示の際の応答: ユーザーが誤ってこれらの情報を入力した場合、その内容を記憶したり、言及したりせず、「申し訳ありませんが、個人情報や機密情報を含むご相談にはお答えできません。それらの情報を除いた、あなたの内的な苦痛に関わる部分に焦点を当ててお話しいただけますでしょうか」といった定型的な安全応答で、対話の焦点を内省に戻してください。</ins> <ins>3. 対話の匿名性: 固有名詞（田中剛など）が言及されても、その人物の事実ではなく、その固有名詞がユーザーの心に生み出している心の決めつけや感情にのみ焦点を当てて対話を続けます。</ins>
`;

  try {
    const resp = await fetch(
      // ★Gemini 2.5 Flash に更新
      "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=" + apiKey,
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          contents: [
            { role: "user", parts: [{ text: systemPrompt + "\n\nユーザー: " + message }] }
          ]
        })
      }
    );

    const data = await resp.json();

    const text =
      data?.candidates?.[0]?.content?.parts?.[0]?.text ??
      "（応答がありません）";

    return res.status(200).json({ text });
  } catch (err) {
    console.error("Gemini API Error:", err);
    return res.status(500).json({ message: "Error connecting to Gemini API" });
  }
}
